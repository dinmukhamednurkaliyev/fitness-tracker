name: Flutter Test & Coverage

on:
  workflow_call:
    secrets:
      CODECOV_TOKEN:
        required: false

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v6.0.1

      - uses: ./.github/actions/setup-flutter/
        id: setup

      - name: Install lcov
        if: steps.setup.outputs.installed == 'true'
        run: |
          if ! command -v lcov &> /dev/null; then
            sudo apt-get update -q && sudo apt-get install -y lcov
          fi

      - name: Run tests with coverage
        if: steps.setup.outputs.installed == 'true'
        run: melos exec -c 6 --fail-fast -- "flutter test --coverage"

      - name: Merge and clean coverage
        if: steps.setup.outputs.installed == 'true'
        id: merge_coverage
        run: |
          mkdir -p coverage

          find . -type f -name "lcov.info" -not -path "./coverage/*" > lcov_files.txt

          if [ ! -s lcov_files.txt ]; then
            echo "⚠️ No lcov.info files found."
            echo "skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Merging $(wc -l < lcov_files.txt) files..."
          cat lcov_files.txt | xargs lcov --add-file > coverage/lcov.raw.info

          lcov --remove coverage/lcov.raw.info \
            "*/test/*" "*/generated/*" "*/lib/*.g.dart" \
            "*/lib/*.freezed.dart" "*/lib/*.gr.dart" \
            "*/.dart_tool/*" \
            -o coverage/lcov.info --ignore-errors unused

          if [ ! -s coverage/lcov.info ]; then
             echo "⚠️ Coverage file is empty after filtering."
             echo "skipped=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          echo "skipped=false" >> $GITHUB_OUTPUT

          genhtml coverage/lcov.info -o coverage/html \
            --ignore-errors source \
            --title "Flutter Coverage Report"

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v5
        if: steps.setup.outputs.installed == 'true' && steps.merge_coverage.outputs.skipped != 'true'
        with:
          name: flutter-coverage-html
          path: coverage/html
          retention-days: 7

      - name: Upload to Codecov
         if: steps.setup.outputs.installed == 'true' && steps.merge_coverage.outputs.skipped != 'true'
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage/lcov.info
          fail_ci_if_error: true
          verbose: true
