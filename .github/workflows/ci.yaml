name: CI

on:
  push:
    branches: [main, release/**]
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check:
    name: Lint → Analyze → Test → Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Detect changed parts
        uses: dorny/paths-filter@v3.0.2
        id: changes
        with:
          filters: |
            flutter:
              - 'applications/**'
              - 'packages/**'
              - 'melos.yaml'
              - '**/*.dart'
            go:
              - 'services/**'
              - 'go.*'
              - '**/*.go'
            proto:
              - 'proto/**'

      - name: Setup Flutter
        if: steps.changes.outputs.flutter == 'true'
        uses: subosito/flutter-action@v2.21.0
        with:
          channel: stable
          version: "3.38.4"
          cache: true

      - name: Setup Melos
        if: steps.changes.outputs.flutter == 'true'
        run: flutter pub global activate melos

      - name: Dart format check
        if: steps.changes.outputs.flutter == 'true'
        run: melos run format:check

      - name: Dart analyze
        if: steps.changes.outputs.flutter == 'true'
        run: melos run analyze:all

      - name: Flutter tests + coverage
        if: steps.changes.outputs.flutter == 'true'
        run: |
          melos run test:coverage
          find . -name "coverage" -exec cp {}/lcov.info coverage_{{ hashFiles('**/lcov.info') }}.info \;

      - name: Go mod tidy check
        if: steps.changes.outputs.go == 'true'
        run: |
          cd services/api
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Go tests + race + coverage
        if: steps.changes.outputs.go == 'true'
        run: |
          cd services/api
          go test ./... -race -coverprofile=coverage.txt -covermode=atomic

      - name: Go lint (golangci-lint)
        if: steps.changes.outputs.go == 'true'
        uses: golangci/golangci-lint-action@v9.2.0
        with:
          version: v2.7.0
          working-directory: services/api
          args: --timeout=5m

      - name: All good
        run: echo "CI passed in ${{ steps.changes.outputs.count }} changed parts"
